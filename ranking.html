<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025맥스북부실기테스트</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css" rel="stylesheet" />
  <style>
    body {
      font-size: 0.9em;
      padding: 1em;
      background: #fff;
    }
    h2 {
      margin-top: 2em;
      font-size: 1.2em;
      text-align: center;
    }
    select, input, button {
      font-size: 1em;
      padding: 0.4em;
      vertical-align: middle;
    }
    .view-controls {
      text-align: center;
      margin-top: 1em;
    }
    .filter-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5em;
      margin-top: 1em;
    }
    table {
      width: 100%;
      font-size: 0.85em;
      margin-top: 0.5em;
    }
    th, td {
      text-align: center;
      padding: 0.3em;
    }
    .gold { background: gold; font-weight: bold; }
    .silver { background: silver; font-weight: bold; }
    .bronze { background: #cd7f32; font-weight: bold; }
    .highlight { background: #e0f7fa; }
    .section { margin-top: 2em; }
  </style>
</head>
<body>
  <h1 style="text-align: center;">2025맥스북부실기테스트</h1>
  <div class="view-controls">
    <label>
      보기 선택:
      <select id="viewSelect" onchange="loadRankings()">
        <option value="total_all">총점 전체 TOP30</option>
        <option value="total_gender">총점 남자/여자 TOP30</option>
        <option value="total_yebi">총점 예비반 TOP30</option>
        <option value="jump">제자리멀리뛰기</option>
        <option value="medicineball">메디신볼던지기</option>
        <option value="shuttle">10m 왕복달리기</option>
        <option value="sit_reach">좌전굴</option>
        <option value="back_strength">배근력</option>
      </select>
    </label>
  </div>

  <div class="filter-controls">
    <input type="text" id="filterInput" placeholder="지점 또는 이름 검색" />
    <button onclick="loadRankings()">검색</button>
  </div>

  <div id="rankings"></div>

  <script>
    let allData = [];

    async function fetchData() {
      const res = await fetch('https://supermax.kr/feed/all-records');
      allData = await res.json();
      loadRankings();
    }

    function loadRankings() {
      const selected = document.getElementById('viewSelect').value;
      const filterText = document.getElementById('filterInput').value.trim().toLowerCase();

      const displayNames = {
        total: '총점',
        jump: '제자리멀리뛰기',
        medicineball: '메디신볼던지기',
        shuttle: '10m 왕복달리기',
        sit_reach: '좌전굴',
        back_strength: '배근력'
      };

      let event = selected;
      let mode = 'gender';
      if (selected.startsWith('total_')) {
        event = 'total';
        mode = selected.split('_')[1];
      }

      const key = event === 'total' ? 'total_score' : `${event}_record`;
      const isReverse = ['shuttle'].includes(event);

      const filtered = allData.filter(d => {
        const hasValue = d[key] !== null && d[key] !== undefined;
        const matchesFilter = !filterText ||
          d.branch?.toLowerCase().includes(filterText) ||
          d.name?.toLowerCase().includes(filterText);
        return hasValue && matchesFilter;
      });

      const male = filtered.filter(d => d.gender === '남');
      const female = filtered.filter(d => d.gender === '여');
      const yebi = filtered.filter(d => parseInt(d.grade) <= 2);

      let html = '';

      if (event === 'total') {
        if (mode === 'all') {
          const totalRank = rankify(filtered, event);
          html += `
            <div class="section">
              <h2>${displayNames[event]} 전체 TOP30</h2>
              ${renderTable(totalRank, key)}
            </div>
          `;
        } else if (mode === 'gender') {
          const maleRank = rankify(male, event);
          const femaleRank = rankify(female, event);
          html += `
            <div class="section">
              <h2>${displayNames[event]} 남자 TOP30</h2>
              ${renderTable(maleRank, key)}
            </div>
            <div class="section">
              <h2>${displayNames[event]} 여자 TOP30</h2>
              ${renderTable(femaleRank, key)}
            </div>
          `;
        } else if (mode === 'yebi') {
          const yebiRank = rankify(yebi, event);
          html += `
            <div class="section">
              <h2>${displayNames[event]} 예비반 TOP30 (1~2학년)</h2>
              ${renderTable(yebiRank, key)}
            </div>
          `;
        }
      } else {
        const maleRank = rankify(male, event);
        const femaleRank = rankify(female, event);
        html += `
          <div class="section">
            <h2>${displayNames[event]} 남자 TOP30</h2>
            ${renderTable(maleRank, key)}
          </div>
          <div class="section">
            <h2>${displayNames[event]} 여자 TOP30</h2>
            ${renderTable(femaleRank, key)}
          </div>
        `;
      }

      document.getElementById('rankings').innerHTML = html;
    }

    function rankify(list, event) {
      const key = event === 'total' ? 'total_score' : `${event}_record`;
      const isReverse = ['shuttle'].includes(event);

      const withTieBreaker = [...list].map(s => {
        let tiebreaker = 0;
        if (event !== 'total') {
          const scores = [s.jump_score || 0, s.medicineball_score || 0, s.shuttle_score || 0];
          tiebreaker = scores.reduce((a, b) => a + b, 0);
        }
        return { ...s, _value: s[key], _tiebreaker: tiebreaker };
      });

      return withTieBreaker.sort((a, b) => {
        if (a._value === b._value) return b._tiebreaker - a._tiebreaker;
        return isReverse ? a._value - b._value : b._value - a._value;
      }).slice(0, 30);
    }

    function renderTable(list, key) {
      return `
        <table>
          <thead>
            <tr><th>순위</th><th>수험번호</th><th>이름</th><th>지점</th><th>학년</th><th>성별</th><th>${key === 'total_score' ? '점수' : '기록'}</th></tr>
          </thead>
          <tbody>
            ${list.map((s, i) => {
              const medalClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : i < 10 ? 'highlight' : '';
              return `
                <tr class="${medalClass}">
                  <td>${i + 1}</td>
                  <td>${s.exam_number}</td>
                  <td>${s.name}</td>
                  <td>${s.branch}</td>
                  <td>${s.grade}</td>
                  <td>${s.gender}</td>
                  <td>${s[key]}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    fetchData();
  </script>
</body>
</html>
